setup:
  - skip:
      features: close_to

  - requires:
      cluster_features: 'rrf_retriever_supported'
      reason: 'test requires rrf retriever implementation'

  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
          mappings:
            properties:
              text:
                type: text
              keyword:
                type: keyword
              vector:
                type: dense_vector
                dims: 1
                index: true
                similarity: l2_norm
                index_options:
                  type: hnsw
                  ef_construction: 100
                  m: 16

  - do:
      index:
        index: test
        id: "1"
        body:
          text: "term term term term term term term term term"
          vector: [1.0]

  - do:
      index:
        index: test
        id: "2"
        body:
          text: "term term term term term term term term"
          keyword: "biology"
          vector: [2.0]

  - do:
      index:
        index: test
        id: "3"
        body:
          text: "term term term term term term term"
          keyword: "technology"
          vector: [3.0]

  - do:
      index:
        index: test
        id: "4"
        body:
          text: "term term term term term term"
          vector: [4.0]
  - do:
      index:
        index: test
        id: "5"
        body:
          text: "term term term term term"
          keyword: "technology"
          vector: [5.0]
  - do:
      index:
        index: test
        id: "6"
        body:
          text: "term term term term"
          keyword: "biology"
          vector: [6.0]
  - do:
      index:
        index: test
        id: "7"
        body:
          text: "term term term"
          keyword: "astronomy"
          vector: [7.0]
  - do:
      index:
        index: test
        id: "8"
        body:
          text: "term term"
          keyword: "technology"
          vector: [8.0]
  - do:
      index:
        index: test
        id: "9"
        body:
          text: "term"
          keyword: "technology"
          vector: [9.0]
  - do:
      indices.refresh: {}

---
"rrf retriever with aggs":

  - do:
      search:
        index: test
        body:
          track_total_hits: false
          retriever:
            rrf:
              retrievers: [
                {
                  knn: {
                    field: vector,
                    query_vector: [ 6.0 ],
                    k: 3,
                    num_candidates: 3
                  }
                },
                {
                  standard: {
                    query: {
                      term: {
                        text: term
                      }
                    }
                  }
                }
              ]
              rank_window_size: 5
              rank_constant: 10
          size: 3
          aggs:
            keyword_aggs:
              terms:
                field: keyword

  - match: { hits.hits.0._id: "5" }
  - match: { hits.hits.0._rank: 1 }

  - match: { hits.hits.1._id: "6" }
  - match: { hits.hits.1._rank: 2 }

  - match: { hits.hits.2._id: "1" }
  - match: { hits.hits.2._rank: 3 }

  - match: { aggregations.keyword_aggs.buckets.0.key: "technology" }
  - match: { aggregations.keyword_aggs.buckets.0.doc_count: 4 }
  - match: { aggregations.keyword_aggs.buckets.1.key: "biology" }
  - match: { aggregations.keyword_aggs.buckets.1.doc_count: 2 }
  - match: { aggregations.keyword_aggs.buckets.2.key: "astronomy" }
  - match: { aggregations.keyword_aggs.buckets.2.doc_count: 1 }


---
"rrf retriever with aggs - scripted metric using score":

  - do:
      search:
        index: test
        body:
          track_total_hits: false
          retriever:
            rrf:
              retrievers: [
                {
                  knn: {
                    field: vector,
                    query_vector: [ 6.0 ],
                    k: 3,
                    num_candidates: 3
                  }
                },
                {
                  standard: {
                    query: {
                      term: {
                        text: term
                      }
                    }
                  }
                }
              ]
              rank_window_size: 5
              rank_constant: 10
          size: 3
          aggs:
            max_score:
              max:
                script:
                  lang: painless
                  source: "_score"


  - match: { hits.hits.0._id: "5" }
  - match: { hits.hits.0._rank: 1 }

  - match: { hits.hits.1._id: "6" }
  - match: { hits.hits.1._rank: 2 }

  - match: { hits.hits.2._id: "1" }
  - match: { hits.hits.2._rank: 3 }

  - close_to: { aggregations.max_score.value: { value: 1.1808, error: 0.001 }}
