setup:
  - requires:
      cluster_features: 'rrf_retriever_supported'
      reason: 'test requires rrf retriever implementation'

  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
          mappings:
            properties:
              vector:
                type: dense_vector
                dims: 1
                index: true
                similarity: l2_norm
                index_options:
                  type: hnsw
                  ef_construction: 100
                  m: 16
              keyword:
                type: keyword

  - do:
      index:
        index: test
        id: "1"
        body:
          vector: [1.0]
          keyword: A
  - do:
      index:
        index: test
        id: "2"
        body:
          vector: [2.0]
          keyword: B

  - do:
      index:
        index: test
        id: "3"
        body:
          vector: [3.0]
          keyword: B

  - do:
      indices.refresh: {}

---
"rrf retriever with global min_score":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          track_total_hits: true
          retriever:
            rrf:
              retrievers: [
                {
                  # this one retrievers docs 1 and 2
                  knn: {
                    field: vector,
                    query_vector: [ 1.0 ],
                    k: 2,
                    num_candidates: 10
                  }
                },
                {
                  # this one retrieves docs 2 and 3
                  standard: {
                    query: {
                      term: {
                        keyword: B
                      }
                    }
                  }
                }
              ]
              rank_window_size: 5
              rank_constant: 10
          size: 3
          min_score: 0.1

  - match: { hits.total : 3 }

  - match: { hits.hits.0._id: "2" }
  - match: { hits.hits.0._rank: 1 }

---
"rrf retriever with retriever-level min_score":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          track_total_hits: true
          retriever:
            rrf:
              retrievers: [
                {
                  # this one retrieves doc 1
                  knn: {
                    field: vector,
                    query_vector: [ 1.0 ],
                    k: 10,
                    num_candidates: 10,
                    similarity: 0.0
                  }
                },
                {
                  # this one retrieves no docs
                  standard: {
                    query: {
                      term: {
                        keyword: B
                      }
                    },
                    min_score: 100
                  }
                }
              ]
              rank_window_size: 10
              rank_constant: 10
          size: 10

  - length: { hits.hits : 1 }

  - match: { hits.hits.0._id: "1" }
  - match: { hits.hits.0._rank: 1 }
